var F=Object.defineProperty;var g=(e,t)=>{for(var n in t)F(e,n,{get:t[n],enumerable:!0})};var u=e=>{throw new Error("Not initialized yet")},P=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var x=new Map,y=0;P&&(globalThis.syscall=async(e,...t)=>await new Promise((n,o)=>{y++,x.set(y,{resolve:n,reject:o}),u({type:"sys",id:y,name:e,args:t})}));function h(e,t,n){P&&(u=n,self.addEventListener("message",o=>{(async()=>{let i=o.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));u({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),u({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=x.get(a);if(!s)throw Error("Invalid request id");x.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),u({type:"manifest",manifest:t}))}function k(e){let t=atob(e),n=t.length,o=new Uint8Array(n);for(let i=0;i<n;i++)o[i]=t.charCodeAt(i);return o}function v(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",n=e.byteLength;for(let o=0;o<n;o++)t+=String.fromCharCode(e[o]);return btoa(t)}async function M(e,t){if(typeof e!="string"){let n=new Uint8Array(await e.arrayBuffer()),o=n.length>0?v(n):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function T(){globalThis.fetch=async function(e,t){let n=t&&t.body?v(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await M(e,t&&{method:t.method,headers:t.headers,base64Body:n});return new Response(o.base64Body?k(o.base64Body):null,{status:o.status,headers:o.headers})}}P&&T();var l={};g(l,{confirm:()=>oe,copyToClipboard:()=>ge,deleteLine:()=>ye,dispatch:()=>re,downloadFile:()=>V,filterBox:()=>z,flashNotification:()=>H,fold:()=>ae,foldAll:()=>ue,getCurrentPage:()=>E,getCursor:()=>L,getSelection:()=>K,getText:()=>U,getUiOption:()=>ie,goHistory:()=>Q,hidePanel:()=>Y,insertAtCursor:()=>te,insertAtPos:()=>J,moveCursor:()=>Z,moveCursorToLine:()=>ee,navigate:()=>q,openCommandPalette:()=>W,openPageNavigator:()=>j,openSearchPanel:()=>fe,openUrl:()=>N,prompt:()=>ne,redo:()=>pe,reloadConfigAndCommands:()=>_,reloadPage:()=>B,reloadUI:()=>O,replaceRange:()=>X,save:()=>D,setSelection:()=>$,setText:()=>R,setUiOption:()=>se,showPanel:()=>G,toggleFold:()=>le,undo:()=>de,unfold:()=>ce,unfoldAll:()=>me,uploadFile:()=>I,vimEx:()=>xe});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function E(){return r("editor.getCurrentPage")}function U(){return r("editor.getText")}function R(e){return r("editor.setText",e)}function L(){return r("editor.getCursor")}function K(){return r("editor.getSelection")}function $(e,t){return r("editor.setSelection",e,t)}function D(){return r("editor.save")}function q(e,t=!1,n=!1){return r("editor.navigate",e,t,n)}function j(e="page"){return r("editor.openPageNavigator",e)}function W(){return r("editor.openCommandPalette")}function B(){return r("editor.reloadPage")}function O(){return r("editor.reloadUI")}function _(){return r("editor.reloadConfigAndCommands")}function N(e,t=!1){return r("editor.openUrl",e,t)}function Q(e){return r("editor.goHistory",e)}function V(e,t){return r("editor.downloadFile",e,t)}function I(e,t){return r("editor.uploadFile",e,t)}function H(e,t="info"){return r("editor.flashNotification",e,t)}function z(e,t,n="",o=""){return r("editor.filterBox",e,t,n,o)}function G(e,t,n,o=""){return r("editor.showPanel",e,t,n,o)}function Y(e){return r("editor.hidePanel",e)}function J(e,t){return r("editor.insertAtPos",e,t)}function X(e,t,n){return r("editor.replaceRange",e,t,n)}function Z(e,t=!1){return r("editor.moveCursor",e,t)}function ee(e,t=1,n=!1){return r("editor.moveCursorToLine",e,t,n)}function te(e){return r("editor.insertAtCursor",e)}function re(e){return r("editor.dispatch",e)}function ne(e,t=""){return r("editor.prompt",e,t)}function oe(e){return r("editor.confirm",e)}function ie(e){return r("editor.getUiOption",e)}function se(e,t){return r("editor.setUiOption",e,t)}function ae(){return r("editor.fold")}function ce(){return r("editor.unfold")}function le(){return r("editor.toggleFold")}function ue(){return r("editor.foldAll")}function me(){return r("editor.unfoldAll")}function de(){return r("editor.undo")}function pe(){return r("editor.redo")}function fe(){return r("editor.openSearchPanel")}function ge(e){return r("editor.copyToClipboard",e)}function ye(){return r("editor.deleteLine")}function xe(e){return r("editor.vimEx",e)}var m={};g(m,{deleteAttachment:()=>Te,deleteFile:()=>Ke,deletePage:()=>Ae,fileExists:()=>$e,getAttachmentMeta:()=>Fe,getFileMeta:()=>Re,getPageMeta:()=>ve,listAttachments:()=>Ce,listFiles:()=>Ee,listPages:()=>he,listPlugs:()=>Se,readAttachment:()=>ke,readFile:()=>Ue,readPage:()=>be,writeAttachment:()=>Me,writeFile:()=>Le,writePage:()=>we});function he(){return r("space.listPages")}function ve(e){return r("space.getPageMeta",e)}function be(e){return r("space.readPage",e)}function we(e,t){return r("space.writePage",e,t)}function Ae(e){return r("space.deletePage",e)}function Se(){return r("space.listPlugs")}function Ce(){return r("space.listAttachments")}function Fe(e){return r("space.getAttachmentMeta",e)}function ke(e){return r("space.readAttachment",e)}function Me(e,t){return r("space.writeAttachment",e,t)}function Te(e){return r("space.deleteAttachment",e)}function Ee(){return r("space.listFiles")}function Ue(e){return r("space.readFile",e)}function Re(e){return r("space.getFileMeta",e)}function Le(e,t){return r("space.writeFile",e,t)}function Ke(e){return r("space.deleteFile",e)}function $e(e){return r("space.fileExists",e)}var d={};g(d,{applyAttributeExtractors:()=>Oe,getEnv:()=>Ve,getMode:()=>Ie,getSpaceConfig:()=>_e,getVersion:()=>He,invokeCommand:()=>qe,invokeFunction:()=>De,invokeSpaceFunction:()=>Be,listCommands:()=>je,listSyscalls:()=>We,reloadConfig:()=>Qe,reloadPlugs:()=>Ne});function De(e,...t){return r("system.invokeFunction",e,...t)}function qe(e,t){return r("system.invokeCommand",e,t)}function je(){return r("system.listCommands")}function We(){return r("system.listSyscalls")}function Be(e,...t){return r("system.invokeSpaceFunction",e,...t)}function Oe(e,t,n){return r("system.applyAttributeExtractors",e,t,n)}async function _e(e,t){return await r("system.getSpaceConfig",e)??t}function Ne(){return r("system.reloadPlugs")}function Qe(){return r("system.reloadConfig")}function Ve(){return r("system.getEnv")}function Ie(){return r("system.getMode")}function He(){return r("system.getVersion")}var p=class{constructor(t,n,o="main"){this._user=t;this._repository=n;this._baseUrl=`https://raw.githubusercontent.com/${t}/${n}/refs/heads/${o}`,this.key=`gh://${t}/${n}`}_baseUrl;key;resolveUrl(t){let[n,...o]=t.split(this._repository),i=o.join("/");return this.resolvePath(i)}resolvePath(t){let n=t.startsWith("/")?t.slice(1):t;return`${this._baseUrl}/${n}`}};var f=class{constructor(t,n="https"){this._domain=t;this._scheme=n;this.key=t}key;resolveUrl(t){return t}resolvePath(t){return`${this._scheme}://${this._domain}/${t}`}};async function b(){let e=await d.getSpaceConfig("externalLibraries",[]),t={};for(let n of e)await at(n,t)}async function at(e,t){let{resolver:n,path:o}=lt(e);if(n===void 0||o===void 0){await l.flashNotification("Skipping library "+e,"error"),console.warn("Skipping External Library, because of unknown scheme",e);return}let i=w(o.split("/"));if(i===void 0){await l.flashNotification("Skipping library "+e,"error"),console.warn("Skipping External Library, because it does not contain a Library directory",e);return}let a=i.join("/");if(o=ct(o,a),t[n.key]===void 0){let c=await fetch(n.resolvePath(`${a}/index.json`));t[n.key]=await c.json()}let s=t[n.key].filter(c=>c.name.startsWith(o));await l.flashNotification(`Downloading ${s.length} files for library '${e}'`);for(let c of s){let C=await(await fetch(n.resolvePath(`${a}/${c.name}`))).text();m.writeAttachment(c.name,new TextEncoder().encode(C))}}function ct(e,t){return e=e.substring(t.length),e.startsWith("/")&&(e=e.substring(1)),e}function lt(e){let[t,n]=e.split("://");console.log("extLib | Lib",t,n);let o,i;if(t==="gh"||t==="github"){let[a,s,...c]=n.split("/");o=new p(a,s),i=c.join("/")}else if(t==="https"||t==="http"){let[a,...s]=n.split("/");o=new f(a,t),i=s.join("/")}else return{};return{resolver:o,path:i}}function w([e,...t],n=[]){if(e!==void 0)return e==="Library"?n:(n.push(e),w(t,n))}var A={downloadExternalLibraries:b},S={name:"external-libraries",requiredPermissions:["fetch"],functions:{downloadExternalLibraries:{path:"plug/external-libraries.ts:downloadExternalLibraries",command:{name:"External Libraries: Update"}}},assets:{}},Vt={manifest:S,functionMapping:A};h(A,S,self.postMessage);export{Vt as plug};
