var M=Object.defineProperty;var g=(e,t)=>{for(var o in t)M(e,o,{get:t[o],enumerable:!0})};var c=e=>{throw new Error("Not initialized yet")},P=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var x=new Map,y=0;P&&(globalThis.syscall=async(e,...t)=>await new Promise((o,n)=>{y++,x.set(y,{resolve:o,reject:n}),c({type:"sys",id:y,name:e,args:t})}));function v(e,t,o){P&&(c=o,self.addEventListener("message",n=>{(async()=>{let i=n.data;switch(i.type){case"inv":{let a=e[i.name];if(!a)throw new Error(`Function not loaded: ${i.name}`);try{let s=await Promise.resolve(a(...i.args||[]));c({type:"invr",id:i.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",i.name,"error:",s.message),c({type:"invr",id:i.id,error:s.message})}}break;case"sysr":{let a=i.id,s=x.get(a);if(!s)throw Error("Invalid request id");x.delete(a),i.error?s.reject(new Error(i.error)):s.resolve(i.result)}break}})().catch(console.error)}),c({type:"manifest",manifest:t}))}function T(e){let t=atob(e),o=t.length,n=new Uint8Array(o);for(let i=0;i<o;i++)n[i]=t.charCodeAt(i);return n}function b(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",o=e.byteLength;for(let n=0;n<o;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function E(e,t){if(typeof e!="string"){let o=new Uint8Array(await e.arrayBuffer()),n=o.length>0?b(o):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function k(){globalThis.fetch=async function(e,t){let o=t&&t.body?b(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await E(e,t&&{method:t.method,headers:t.headers,base64Body:o});return new Response(n.base64Body?T(n.base64Body):null,{status:n.status,headers:n.headers})}}P&&k();var l={};g(l,{confirm:()=>le,copyToClipboard:()=>be,deleteLine:()=>he,dispatch:()=>ae,downloadFile:()=>Y,filterBox:()=>Z,flashNotification:()=>X,fold:()=>de,foldAll:()=>ge,getCurrentEditor:()=>R,getCurrentPage:()=>A,getCurrentPageMeta:()=>L,getCurrentPath:()=>D,getCursor:()=>O,getSelection:()=>q,getText:()=>U,getUiOption:()=>ce,goHistory:()=>G,hidePanel:()=>te,insertAtCursor:()=>se,insertAtPos:()=>re,moveCursor:()=>ne,moveCursorToLine:()=>ie,moveLineDown:()=>Ce,moveLineUp:()=>we,navigate:()=>W,newWindow:()=>z,openCommandPalette:()=>_,openPageNavigator:()=>Q,openSearchPanel:()=>ve,openUrl:()=>H,prompt:()=>ue,rebuildEditorState:()=>V,redo:()=>Pe,reloadConfigAndCommands:()=>I,reloadPage:()=>B,reloadUI:()=>N,replaceRange:()=>oe,save:()=>K,sendMessage:()=>Se,setSelection:()=>$,setText:()=>j,setUiOption:()=>me,showPanel:()=>ee,toggleFold:()=>fe,undo:()=>xe,unfold:()=>pe,unfoldAll:()=>ye,uploadFile:()=>J,vimEx:()=>Fe});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function r(e,...t){return globalThis.syscall(e,...t)}function A(){return r("editor.getCurrentPage")}function L(){return r("editor.getCurrentPageMeta")}function D(e=!1){return r("editor.getCurrentPath",e)}function R(){return r("editor.getCurrentEditor")}function U(){return r("editor.getText")}function j(e,t=!1){return r("editor.setText",e,t)}function O(){return r("editor.getCursor")}function q(){return r("editor.getSelection")}function $(e,t){return r("editor.setSelection",e,t)}function K(){return r("editor.save")}function W(e,t=!1,o=!1){return r("editor.navigate",e,t,o)}function Q(e="page"){return r("editor.openPageNavigator",e)}function _(){return r("editor.openCommandPalette")}function B(){return r("editor.reloadPage")}function N(){return r("editor.reloadUI")}function V(){return r("editor.rebuildEditorState")}function I(){return r("editor.reloadConfigAndCommands")}function H(e,t=!1){return r("editor.openUrl",e,t)}function z(){return r("editor.newWindow")}function G(e){return r("editor.goHistory",e)}function Y(e,t){return r("editor.downloadFile",e,t)}function J(e,t){return r("editor.uploadFile",e,t)}function X(e,t="info"){return r("editor.flashNotification",e,t)}function Z(e,t,o="",n=""){return r("editor.filterBox",e,t,o,n)}function ee(e,t,o,n=""){return r("editor.showPanel",e,t,o,n)}function te(e){return r("editor.hidePanel",e)}function re(e,t){return r("editor.insertAtPos",e,t)}function oe(e,t,o){return r("editor.replaceRange",e,t,o)}function ne(e,t=!1){return r("editor.moveCursor",e,t)}function ie(e,t=1,o=!1){return r("editor.moveCursorToLine",e,t,o)}function se(e,t=!1){return r("editor.insertAtCursor",e,t)}function ae(e){return r("editor.dispatch",e)}function ue(e,t=""){return r("editor.prompt",e,t)}function le(e){return r("editor.confirm",e)}function ce(e){return r("editor.getUiOption",e)}function me(e,t){return r("editor.setUiOption",e,t)}function de(){return r("editor.fold")}function pe(){return r("editor.unfold")}function fe(){return r("editor.toggleFold")}function ge(){return r("editor.foldAll")}function ye(){return r("editor.unfoldAll")}function xe(){return r("editor.undo")}function Pe(){return r("editor.redo")}function ve(){return r("editor.openSearchPanel")}function be(e){return r("editor.copyToClipboard",e)}function he(){return r("editor.deleteLine")}function we(){return r("editor.moveLineUp")}function Ce(){return r("editor.moveLineDown")}function Fe(e){return r("editor.vimEx",e)}function Se(e,t){return r("editor.sendMessage",e,t)}var m={};g(m,{deleteDocument:()=>qe,deleteFile:()=>_e,deletePage:()=>Le,fileExists:()=>Be,getDocumentMeta:()=>Ue,getFileMeta:()=>We,getPageMeta:()=>Ee,listDocuments:()=>Re,listFiles:()=>$e,listPages:()=>Te,listPlugs:()=>De,readDocument:()=>je,readFile:()=>Ke,readPage:()=>ke,writeDocument:()=>Oe,writeFile:()=>Qe,writePage:()=>Ae});function Te(){return r("space.listPages")}function Ee(e){return r("space.getPageMeta",e)}function ke(e){return r("space.readPage",e)}function Ae(e,t){return r("space.writePage",e,t)}function Le(e){return r("space.deletePage",e)}function De(){return r("space.listPlugs")}function Re(){return r("space.listDocuments")}function Ue(e){return r("space.getDocumentMeta",e)}function je(e){return r("space.readDocument",e)}function Oe(e,t){return r("space.writeDocument",e,t)}function qe(e){return r("space.deleteDocument",e)}function $e(){return r("space.listFiles")}function Ke(e){return r("space.readFile",e)}function We(e){return r("space.getFileMeta",e)}function Qe(e,t){return r("space.writeFile",e,t)}function _e(e){return r("space.deleteFile",e)}function Be(e){return r("space.fileExists",e)}var d={};g(d,{applyAttributeExtractors:()=>Ge,getEnv:()=>Ze,getMode:()=>et,getSpaceConfig:()=>Ye,getVersion:()=>tt,invokeCommand:()=>Ve,invokeFunction:()=>Ne,invokeSpaceFunction:()=>ze,listCommands:()=>Ie,listSyscalls:()=>He,reloadConfig:()=>Xe,reloadPlugs:()=>Je});function Ne(e,...t){return r("system.invokeFunction",e,...t)}function Ve(e,t){return r("system.invokeCommand",e,t)}function Ie(){return r("system.listCommands")}function He(){return r("system.listSyscalls")}function ze(e,...t){return r("system.invokeSpaceFunction",e,...t)}function Ge(e,t,o){return r("system.applyAttributeExtractors",e,t,o)}async function Ye(e,t){return await r("system.getSpaceConfig",e)??t}function Je(){return r("system.reloadPlugs")}function Xe(){return r("system.reloadConfig")}function Ze(){return r("system.getEnv")}function et(){return r("system.getMode")}function tt(){return r("system.getVersion")}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var p=class{constructor(t,o,n="main"){this._user=t;this._repository=o;this._baseUrl=`https://raw.githubusercontent.com/${t}/${o}/refs/heads/${n}`,this.key=`gh://${t}/${o}`}_baseUrl;key;resolveUrl(t){let[o,...n]=t.split(this._repository),i=n.join("/");return this.resolvePath(i)}resolvePath(t){let o=t.startsWith("/")?t.slice(1):t;return`${this._baseUrl}/${o}`}};var f=class{constructor(t,o="https"){this._domain=t;this._scheme=o;this.key=t}key;resolveUrl(t){return t}resolvePath(t){return`${this._scheme}://${this._domain}/${t}`}};async function h(){let e=await d.getSpaceConfig("externalLibraries",[]),t={};for(let o of e)await xt(o,t)}async function xt(e,t){let{resolver:o,path:n}=vt(e);if(o===void 0||n===void 0){await l.flashNotification("Skipping library "+e,"error"),console.warn("Skipping External Library, because of unknown scheme",e);return}let i=w(n.split("/"));if(i===void 0){await l.flashNotification("Skipping library "+e,"error"),console.warn("Skipping External Library, because it does not contain a Library directory",e);return}let a=i.join("/");if(n=Pt(n,a),t[o.key]===void 0){let u=await fetch(o.resolvePath(`${a}/index.json`));t[o.key]=await u.json()}let s=t[o.key].filter(u=>u.name.startsWith(n));await l.flashNotification(`Downloading ${s.length} files for library '${e}'`);for(let u of s){let S=await(await fetch(o.resolvePath(`${a}/${u.name}`))).text();m.writeDocument(u.name,new TextEncoder().encode(S))}}function Pt(e,t){return e=e.substring(t.length),e.startsWith("/")&&(e=e.substring(1)),e}function vt(e){let[t,o]=e.split("://"),n,i;if(t==="gh"||t==="github"){let[a,s,...u]=o.split("/");n=new p(a,s),i=u.join("/")}else if(t==="https"||t==="http"){let[a,...s]=o.split("/");n=new f(a,t),i=s.join("/")}else return{};return{resolver:n,path:i}}function w([e,...t],o=[]){if(e!==void 0)return e==="Library"?o:(o.push(e),w(t,o))}var C={downloadExternalLibraries:h},F={name:"external-libraries",requiredPermissions:["fetch"],functions:{downloadExternalLibraries:{path:"plug/external-libraries.ts:downloadExternalLibraries",command:{name:"External Libraries: Update"}}},assets:{}},nr={manifest:F,functionMapping:C};v(C,F,self.postMessage);export{nr as plug};
